<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emotion Music Recommender</title>
<style>
  :root{
    --bg-1: #f7fbff;
    --bg-2: #eef6ff;
    --muted: #6b7280;
    --accent: #06b6d4;
    --accent-2: #10b981;
  }
  html,body{height:100%;margin:0;}
  body{
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(16,185,129,0.04), transparent 8%),
      radial-gradient(900px 400px at 95% 85%, rgba(6,182,212,0.03), transparent 6%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2));
    -webkit-font-smoothing:antialiased;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    color:#08121a;
  }

  /* Centered card */
  .card {
    width:100%;
    max-width:820px;
    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
    border-radius:18px;
    box-shadow: 0 10px 40px rgba(9,10,11,0.08);
    padding:28px;
    backdrop-filter: blur(6px);
    border: 1px solid rgba(15,23,42,0.04);
  }

  header { display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:6px; }
  .brand { display:flex; gap:12px; align-items:center; }
  #appLogo {
    width:56px; height:56px; border-radius:50%;
    object-fit:cover;
    box-shadow:0 6px 20px rgba(9,10,11,0.12);
    background: #fff;
    padding:6px;
  }
  header h1 { margin:0; font-size:1.35rem; letter-spacing:-0.2px; }
  header .sub { color:var(--muted); font-size:0.95rem; }

  /* Controls */
  .controls { display:flex; gap:10px; align-items:center; margin-top:16px; }
  .controls input[type="text"]{
    flex:1;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(9,10,11,0.06);
    background: linear-gradient(180deg,#fff,#fbfdff);
    font-size:1rem;
  }

  .btn-primary {
    display:inline-flex;
    gap:8px;
    align-items:center;
    padding:10px 14px;
    border-radius:12px;
    border: none;
    cursor:pointer;
    background: linear-gradient(90deg,var(--accent),#0891b2);
    color:white;
    font-weight:600;
    box-shadow: 0 8px 20px rgba(6,182,212,0.12);
    transition:transform .12s ease, box-shadow .12s ease;
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(6,182,212,0.14); }
  .btn-ghost {
    padding:9px 12px;
    border-radius:12px;
    border:1px solid rgba(9,10,11,0.06);
    background:transparent;
    color:#0f172a;
    cursor:pointer;
  }

  .grid { display:grid; grid-template-columns: 1fr 360px; gap:20px; align-items:start; margin-top:18px; }
  @media (max-width:880px){ .grid{ grid-template-columns:1fr; } }

  .info {
    border-radius:12px;
    padding:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
    border:1px solid rgba(9,10,11,0.03);
    box-shadow: 0 6px 18px rgba(9,10,11,0.03);
    font-size:0.95rem;
  }

  /* Result area */
  #appResult { margin-top: 6px; font-size: 0.98rem; }
  .loader-wrap { display:flex; gap:12px; align-items:center; margin-top:12px; }
  .step { display:flex; gap:8px; align-items:center; font-size:0.95rem; color:var(--muted); }
  .step .dot { width:10px; height:10px; border-radius:50%; background:#e6e6e6; }
  .step.active .dot { background:var(--accent-2); transform:scale(1.12); }
  .step.pending .dot { background:#f59e0b; animation:pulse 1s infinite; }

  .skeleton { margin-top:14px; display:grid; gap:12px; }
  .skel-row{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(90deg,rgba(0,0,0,0.03),rgba(0,0,0,0.02));}
  .skel-thumb{width:56px;height:56px;border-radius:8px;background:linear-gradient(90deg,#eee,#f5f5f5);position:relative;overflow:hidden;}
  .skel-lines{flex:1;} .skel-line{height:10px;margin-bottom:8px;border-radius:6px;background:linear-gradient(90deg,#eee,#f5f5f5);width:100%;max-width:70%;}
  .skel-line.short{max-width:40%;}
  .skel-anim::after{content:"";position:absolute;left:-70%;top:0;height:100%;width:70%;background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,0.6),rgba(255,255,255,0));animation:shimmer 1.2s infinite;}
  @keyframes shimmer{0%{left:-70%}100%{left:120%}}

  .track-list{margin-top:12px;display:grid;gap:12px;}
  .track-card{display:flex;gap:12px;padding:12px;border-radius:12px;align-items:center;background:#fff;box-shadow:0 6px 18px rgba(9,10,11,0.04);}
  .track-thumb{width:64px;height:64px;border-radius:8px;background:linear-gradient(180deg,#f7fafc,#f0f6f9);display:flex;align-items:center;justify-content:center;font-weight:700;color:#374151;}
  .track-meta{flex:1;}
  .track-meta .name{font-weight:700;margin-bottom:4px;}
  .track-meta .artist{color:var(--muted);font-size:0.95rem;margin-bottom:6px;}
  .track-actions{display:flex;gap:8px;align-items:center;}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:var(--accent-2);color:white;font-weight:600;}
  .btn.ghost{background:transparent;color:#0f172a;border:1px solid rgba(15,23,42,0.06);}
  .btn.disabled{opacity:0.5;pointer-events:none;}
  .muted{color:var(--muted);font-size:0.92rem;}
  .small{font-size:0.9rem;color:var(--muted);}

  /* Toast */
  #toast { position: fixed; right: 20px; top: 20px; min-width: 220px; padding: 10px 14px; border-radius: 10px; background: rgba(3,105,161,0.95); color:#fff; z-index:9999; opacity:0; transition: opacity .18s, transform .22s; transform: translateY(-6px); pointer-events:none; }
  #toast.show { opacity: 1; transform: translateY(0); pointer-events:auto; }
</style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="appTitle">
    <header>
      <div class="brand">
        <!-- Logo image: save your logo file as "logo.png" in the same folder as this file -->
        <img id="appLogo" src="logo.png" alt="App logo">
        <div>
          <h1 id="appTitle">Emotion Music Recommender</h1>
          <div class="sub">Type how you feel and get a short playlist tailored to your mood.</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;">
        <button id="login" class="btn-ghost" title="Connect Spotify">Connect</button>
        <button id="getSong" class="btn-primary" title="Get Recommendation">Recommend</button>
      </div>
    </header>

    <div class="controls" aria-hidden="false">
      <input id="moodInput" type="text" placeholder="e.g. I want to chill with friends" aria-label="Describe how you feel"/>
      <div style="display:flex;align-items:center;gap:8px;">
        <span id="loader" class="muted small" aria-hidden="true" style="display:none;">Loading…</span>
      </div>
    </div>

    <div class="grid">
      <section>
        <div id="resultPlaceholder"></div>
      </section>

      <aside class="info" aria-label="Tips">
        <strong>Tips</strong>
        <p class="small muted" style="margin-top:8px;">
          Try conversational phrases like "chill with my friends", "need to focus", or "get me hyped". Click a track's Preview to hear a short clip.
        </p>
        <p class="small muted" style="margin-top:10px;">Your Spotify session is stored locally in the browser so you won't need to reconnect every time.</p>
      </aside>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script>
/* Keep UI logic same as before, but mounted defensively */
const API = window.API || "http://127.0.0.1:8000";
if (typeof window.spotifyState === 'undefined') window.spotifyState = null;

/* toast helper */
function showToast(message, { duration = 2800 } = {}) {
  const el = document.getElementById("toast");
  el.textContent = message;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(()=> el.classList.remove("show"), duration);
}

/* remove old result if present */
const old = document.getElementById('result');
if (old) old.remove();

/* mount enhanced UI block */
(function mountEnhancedUI() {
  const container = document.getElementById("resultPlaceholder");
  container.innerHTML = `
    <div id="appResult" aria-live="polite">
      <div class="loader-wrap" id="statusWrap" style="display:none;" aria-hidden="true">
        <div class="step" id="st_connect"><div class="dot"></div><div class="label">Connecting</div></div>
        <div class="step" id="st_search"><div class="dot"></div><div class="label">Searching songs</div></div>
        <div class="step" id="st_buffer"><div class="dot"></div><div class="label">Buffering previews</div></div>
        <div class="step" id="st_done"><div class="dot"></div><div class="label">Done</div></div>
      </div>

      <div class="skeleton" id="skeleton" style="display:none;">
        <div class="skel-row skel-anim"><div class="skel-thumb skel-anim"></div><div class="skel-lines"><div class="skel-line"></div><div class="skel-line short"></div></div></div>
        <div class="skel-row skel-anim"><div class="skel-thumb skel-anim"></div><div class="skel-lines"><div class="skel-line"></div><div class="skel-line short"></div></div></div>
        <div class="skel-row skel-anim"><div class="skel-thumb skel-anim"></div><div class="skel-lines"><div class="skel-line"></div><div class="skel-line short"></div></div></div>
      </div>

      <div id="results" style="display:none;">
        <div id="resultHeader">
          <div>
            <div class="muted">Mood</div>
            <div style="font-size:1.1rem;"><strong id="moodLabel">—</strong> <span id="confidence" style="display:none;"></span></div>
          </div>
          <div class="small">Recommendations tailored to your mood</div>
        </div>

        <div class="track-list" id="trackList" aria-live="polite"></div>

        <div id="noPreviewNote" class="muted small" style="display:none; margin-top:10px;">
          Some tracks might not have short previews available — use "Play on Spotify" to listen full tracks.
        </div>
      </div>

      <div id="error" style="display:none;"></div>
    </div>
  `;
})();

/* Grab UI elements */
const uiLoginBtn = document.getElementById("login");
const uiGetSongBtn = document.getElementById("getSong");
const uiLoader = document.getElementById("loader");

const statusWrap = document.getElementById("statusWrap");
const stConnect = document.getElementById("st_connect");
const stSearch = document.getElementById("st_search");
const stBuffer = document.getElementById("st_buffer");
const stDone = document.getElementById("st_done");
const skeleton = document.getElementById("skeleton");
const resultsEl = document.getElementById("results");
const trackList = document.getElementById("trackList");
const moodLabel = document.getElementById("moodLabel");
const confidenceEl = document.getElementById("confidence");
const errorEl = document.getElementById("error");
const noPreviewNote = document.getElementById("noPreviewNote");

let activeAudio = null;

function setLoading(on = true) {
  if (uiLoader) uiLoader.style.display = on ? "inline" : "none";
  if (uiGetSongBtn) uiGetSongBtn.disabled = on;
  if (uiLoginBtn) uiLoginBtn.disabled = on;
}
function setStep(el, state) { if(!el) return; el.classList.remove("active","pending"); if (state) el.classList.add(state); }
function showStatus(steps = {}) { if (!statusWrap) return; statusWrap.style.display = "flex"; statusWrap.setAttribute("aria-hidden","false"); setStep(stConnect, steps.connect); setStep(stSearch, steps.search); setStep(stBuffer, steps.buffer); setStep(stDone, steps.done); }
function showLoadingSkeleton() { if(!skeleton) return; skeleton.style.display = "block"; resultsEl.style.display = "none"; trackList.innerHTML = ""; errorEl.style.display = "none"; noPreviewNote.style.display = "none"; }
function hideLoadingSkeleton() { if(!skeleton) return; skeleton.style.display = "none"; }
function showError(msg) { errorEl.style.display = "block"; errorEl.className = "error-box"; errorEl.textContent = msg; resultsEl.style.display = "none"; skeleton.style.display = "none"; statusWrap.style.display = "none"; }
function escapeHtml(s){ if(!s) return ""; return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function stopActiveAudio() { if (activeAudio) try { activeAudio.pause(); } catch(_){} activeAudio = null; document.querySelectorAll(".track-card .btn").forEach(b => { if (!b.classList.contains("ghost")) b.textContent = b.dataset.default || b.textContent; }); }
function playPreview(url, btn) { if (!url) return; stopActiveAudio(); const audio = new Audio(url); activeAudio = audio; audio.play().catch(err => console.error("Audio play failed", err)); btn.dataset.default = btn.textContent; btn.textContent = "Playing ▶"; audio.onended = () => { btn.textContent = btn.dataset.default || "Preview"; activeAudio = null; }; audio.onerror = () => { btn.textContent = btn.dataset.default || "Preview"; activeAudio = null; showToast("Unable to play preview (maybe not available in your region)."); }; }

function renderTracks(mood, confidence, tracks) {
  resultsEl.style.display = "block";
  moodLabel.textContent = mood || "Unknown";
  if (typeof confidence === "number") { confidenceEl.style.display = "inline-block"; confidenceEl.textContent = `· ${Math.round(confidence*100)}%`; } else { confidenceEl.style.display = "none"; }
  trackList.innerHTML = "";
  let anyPreview = false;
  if (!Array.isArray(tracks)) tracks = [];
  tracks.forEach((t,i) => {
    const card = document.createElement("div"); card.className = "track-card";
    const thumb = document.createElement("div"); thumb.className = "track-thumb"; thumb.textContent = (t.name && t.name[0]) ? t.name[0].toUpperCase() : "♪";
    const meta = document.createElement("div"); meta.className = "track-meta";
    meta.innerHTML = `<div class="name">${i+1}. ${escapeHtml(t.name || "Unknown")}</div><div class="artist">${escapeHtml(t.artist || "Unknown")}</div>`;
    const actions = document.createElement("div"); actions.className = "track-actions";
    const previewBtn = document.createElement("button"); previewBtn.className = "btn"; previewBtn.textContent = "Preview";
    if (!t.preview_url) { previewBtn.classList.add("disabled"); previewBtn.textContent = "No Preview"; } else { anyPreview = true; previewBtn.onclick = ()=> playPreview(t.preview_url, previewBtn); }
    const openBtn = document.createElement("a"); openBtn.className = "btn ghost"; openBtn.href = t.spotify_url || "#"; openBtn.target = "_blank"; openBtn.rel = "noopener noreferrer"; openBtn.textContent = "Play on Spotify"; if (!t.spotify_url) openBtn.classList.add("disabled");
    actions.appendChild(previewBtn); actions.appendChild(openBtn);
    card.appendChild(thumb); card.appendChild(meta); card.appendChild(actions);
    trackList.appendChild(card);
  });
  noPreviewNote.style.display = anyPreview ? "none" : "block";
}

async function analyzeAndRender({text, spotifyState, top_k = 3, use_local = false}) {
  showStatus({connect:'active', search:'idle', buffer:'idle', done:'idle'});
  showLoadingSkeleton();
  showToast("Searching songs…", {duration:2400});
  try {
    await new Promise(r=>setTimeout(r,300));
    showStatus({connect:'active', search:'pending', buffer:'idle', done:'idle'});

    // --- FIX 1: send k/limit in the body; only keep spotify_state in the query
    const res = await fetch(`${API}/analyze?spotify_state=${encodeURIComponent(spotifyState)}`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ text, k: top_k, limit: 3 })
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>null);
      throw new Error(txt || `Server returned ${res.status}`);
    }
    const data = await res.json();

    // --- FIX 2: read the new response shape: moods[] + tracks[]
    const moods = Array.isArray(data.moods) ? data.moods : [];
    const top = moods.length ? moods[0] : { label: "Unknown", score: null };

    showStatus({connect:'active', search:'active', buffer:'pending', done:'idle'});
    await new Promise(r=>setTimeout(r,350));

    const tracks = Array.isArray(data.tracks) ? data.tracks
      : (data.track_name ? [{ name: data.track_name, artist: data.artist, preview_url: data.preview_url, spotify_url: data.spotify_url }] : []);

    hideLoadingSkeleton();
    renderTracks(top.label, top.score, tracks);

    // (optional cosmetic) show chips for top-3 moods without changing layout
    try {
      const header = document.getElementById("resultHeader");
      if (header && moods.length) {
        const existing = header.querySelector(".mood-chips");
        if (existing) existing.remove();
        const chips = document.createElement("div");
        chips.className = "small mood-chips";
        chips.style.marginTop = "8px";
        chips.innerHTML = moods.slice(0,3)
          .map(m => `<span style="display:inline-block;margin-right:8px;padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:#fff">
                       ${escapeHtml(m.label)} · ${Math.round(m.score*100)}%
                     </span>`).join("");
        header.appendChild(chips);
      }
    } catch(_) {}

    showStatus({connect:'active', search:'active', buffer:'active', done:'active'});
    showToast("Recommendations ready ✔", {duration:2200});
  } catch (err) {
    console.error("Analyze error:", err);
    hideLoadingSkeleton();
    showStatus({connect:'active', search:'idle', buffer:'idle', done:'idle'});
    showError("Could not fetch recommendations. Try reconnecting or check the console for details.");
  }
}

/* Wire up buttons */
if (uiGetSongBtn) {
  uiGetSongBtn.onclick = async () => {
    const st = (typeof window.spotifyState !== 'undefined' && window.spotifyState) ? window.spotifyState : (new URLSearchParams(window.location.search).get('spotify_state') || localStorage.getItem('spotify_state'));
    if (!st) return alert("Connect Spotify first!");
    const moodTextEl = document.getElementById("moodInput");
    const moodText = moodTextEl ? moodTextEl.value.trim() : "";
    if (!moodText) return alert("Enter how you feel!");
    setLoading(true);
    try { await analyzeAndRender({text: moodText, spotifyState: st, top_k:4, use_local:false}); } finally { setLoading(false); }
  };
}
if (uiLoginBtn) {
  uiLoginBtn.onclick = () => { window.location.href = `${API}/login`; };
}

/* Persist spotifyState on redirect */
(function(){
  const params = new URLSearchParams(window.location.search);
  if (params.has("spotify_state")) {
    try { window.spotifyState = params.get("spotify_state"); localStorage.setItem("spotify_state", window.spotifyState); } catch(e){}
    showToast("Spotify connected successfully!");
    window.history.replaceState({}, document.title, window.location.pathname);
  } else {
    if (!window.spotifyState) window.spotifyState = localStorage.getItem("spotify_state");
  }
})();

/* error banner */
window.addEventListener('error', (ev) => {
  console.error('Page error captured:', ev.error || ev.message);
  showToast('Script error — check console (F12).', { duration: 6000 });
});
</script>
</body>
</html>
